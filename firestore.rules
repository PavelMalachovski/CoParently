rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function isPartnerOf(userId) {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/users/$(userId)) &&
             get(/databases/$(database)/documents/users/$(userId)).data.partnerId == request.auth.uid;
    }

    function isSharedWith(sharedList) {
      return isAuthenticated() && request.auth.uid in sharedList;
    }

    // Users collection - users can read/write their own profile and read partner's profile
    match /users/{userId} {
      allow read: if isOwner(userId) || isPartnerOf(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    // Events collection - read/write access for owners and shared partners
    match /events/{eventId} {
      // Anyone can read their own events or events shared with them
      allow read: if isAuthenticated() && (
        resource.data.createdByFirebaseUid == request.auth.uid ||
        request.auth.uid in resource.data.sharedWith
      );

      // Users can create events
      allow create: if isAuthenticated() &&
                      request.resource.data.createdByFirebaseUid == request.auth.uid;

      // Users can update events they created or have write permissions
      allow update: if isAuthenticated() && (
        resource.data.createdByFirebaseUid == request.auth.uid ||
        (request.auth.uid in resource.data.sharedWith &&
         resource.data.permissions == 'read_write')
      ) && request.resource.data.lastModifiedBy == request.auth.uid;

      // Users can delete events they created
      allow delete: if isAuthenticated() &&
                      resource.data.createdByFirebaseUid == request.auth.uid;
    }

    // Child info collection - shared between parent pairs
    match /child_info/{childInfoId} {
      // Users can read child info they're associated with
      allow read: if isAuthenticated() &&
                    request.auth.uid in resource.data.sharedWith;

      // Users can create child info
      allow create: if isAuthenticated() &&
                      request.resource.data.createdByFirebaseUid == request.auth.uid &&
                      request.auth.uid in request.resource.data.sharedWith;

      // Users can update child info they have access to
      allow update: if isAuthenticated() &&
                      request.auth.uid in resource.data.sharedWith &&
                      request.resource.data.lastModifiedBy == request.auth.uid;

      // Users can delete child info they created
      allow delete: if isAuthenticated() &&
                      resource.data.createdByFirebaseUid == request.auth.uid;
    }

    // Invitations collection - for co-parent pairing
    match /invitations/{invitationId} {
      // Users can read invitations sent to them or by them
      allow read: if isAuthenticated() && (
        resource.data.toEmail == request.auth.token.email ||
        resource.data.fromUserId == request.auth.uid
      );

      // Users can create invitations
      allow create: if isAuthenticated() &&
                      request.resource.data.fromUserId == request.auth.uid;

      // Users can update invitation status (for accepting/rejecting)
      allow update: if isAuthenticated() && (
        resource.data.toEmail == request.auth.token.email ||
        resource.data.fromUserId == request.auth.uid
      );

      // Users can delete invitations they sent
      allow delete: if isAuthenticated() &&
                      resource.data.fromUserId == request.auth.uid;
    }

    // Notification queue - for Cloud Functions to process
    match /notification_queue/{notificationId} {
      // Users cannot read the notification queue directly
      allow read: if false;

      // Users can add notifications to the queue
      allow create: if isAuthenticated();

      // Only Cloud Functions can update/delete (no auth check)
      allow update, delete: if false;
    }

    // Custody schedules - shared between parent pairs
    match /custody_schedules/{scheduleId} {
      // Users can read schedules they're associated with
      allow read: if isAuthenticated() && (
        resource.data.momUserId == request.auth.uid ||
        resource.data.dadUserId == request.auth.uid
      );

      // Users can create schedules
      allow create: if isAuthenticated() && (
        request.resource.data.momUserId == request.auth.uid ||
        request.resource.data.dadUserId == request.auth.uid
      );

      // Both parents can update schedules
      allow update: if isAuthenticated() && (
        resource.data.momUserId == request.auth.uid ||
        resource.data.dadUserId == request.auth.uid
      );

      // Either parent can delete schedules
      allow delete: if isAuthenticated() && (
        resource.data.momUserId == request.auth.uid ||
        resource.data.dadUserId == request.auth.uid
      );
    }
  }
}

